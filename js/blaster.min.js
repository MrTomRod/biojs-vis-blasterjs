function BlastAlignment(e,t,n,l,i,r,a,d,o,s,c,p,m,u){this.description=e,this.length=t,this.score=n,this.eValue=l,this.identities=i,this.positives=r,this.gaps=a,this.queryStart=d,this.query=o,this.queryEnd=s,this.comparison=c,this.subjectStart=p,this.subject=m,this.subjectEnd=u}function readBlastFile(e){if(window.File&&window.FileReader&&window.FileList&&window.Blob){var t=e.target.files[0];if(t){var n=new FileReader;n.onload=function(e){var t=getQueryLenght(e.target.result),n=getAlignments(e.target.result);createAlignmentComparison(n,t,!0),createAlignmentTable(n),createSingleAlignment(n[0])},n.readAsText(t)}else alert("Failed to load file")}else alert("The File APIs are not fully supported by your browser.")}function getQueryLenght(e){for(var t=e.split("\n"),n=0,l=0;l<t.length;l++)if(t[l].startsWith("Length=")){n=t[l].split("=")[1];break}return n}function getAlignments(e){for(var t=e.split("\n"),n=[],l=0;l<t.length;l++)if(t[l].startsWith(">")){for(var i=t[l].split(">")[1],r="",a=l;""==r;)a+=1,t[a].startsWith("Length=")?r=t[a]:i+=t[a];var d=i,o=r.split("=")[1],s=t[a+2].split(",")[0].split(" ")[3],c=t[a+2].split(",")[1].split(" ")[4],p=t[a+3].split(",")[0].split("(")[1].substr(0,t[a+3].split(",")[0].split("(")[1].length-2),m=t[a+3].split(",")[1].split("(")[1].substr(0,t[a+3].split(",")[1].split("(")[1].length-2),u=t[a+3].split(",")[2].split("(")[1].substr(0,t[a+3].split(",")[2].split("(")[1].length-2),g=t[a+5].substring(5).replace(/^\s+/g,"").split(" ")[0],h=t[a+5].substring(5).replace(/\s+/g,"").replace(/[0-9]/g,""),y=t[a+5].substring(5).replace(/^\s+/g,"").split(" ")[t[a+5].substring(5).replace(/^\s+/g,"").split(" ").length-1],v=t[a+6].replace(/^\s+/g,""),C=t[a+7].substring(5).replace(/^\s+/g,"").split(" ")[0],b=t[a+7].substring(5).replace(/\s+/g,"").replace(/[0-9]/g,""),f=t[a+7].substring(5).replace(/^\s+/g,"").split(" ")[t[a+7].substring(5).replace(/^\s+/g,"").split(" ").length-1];for(a+=9;t[a].startsWith("Query");){var E=t[a].substring(5).replace(/\s+/g,"").replace(/[0-9]/g,"");h+=E,y=t[a].substring(5).replace(/^\s+/g,"").split(" ")[t[a].substring(5).replace(/^\s+/g,"").split(" ").length-1],b+=t[a+2].substring(5).replace(/\s+/g,"").replace(/[0-9]/g,""),f=t[a+2].substring(5).replace(/^\s+/g,"").split(" ")[t[a+2].substring(5).replace(/^\s+/g,"").split(" ").length-1];var x=t[a+1].replace(/^\s+/g,"");if(E.length>x.length)for(var D=E.length-x.length,T=0;D>T;T++)x=" "+x;v+=x,a+=4}var A=new BlastAlignment(d,o,s,c,p,m,u,g,h,y,v,C,b,f);n.push(A)}return n}function getColor(e,t){return 40>t?getDivColor(e,1):t>=40||50>t?getDivColor(e,2):t>=50||80>t?getDivColor(e,3):t>=80||200>t?getDivColor(e,4):getDivColor(e,5)}function getDivColorText(e){switch(e){case 1:return"<40";case 2:return"40-50";case 3:return"50-80";case 4:return"80-200";case 5:return">=200";default:return"0"}}function getDivColor(e,t){if(e)switch(t){case 1:return"#5C6D7E";case 2:return"#9B59B6";case 3:return"#5CACE2";case 4:return"#57D68D";case 5:return"#C0392B";default:return"#FFF"}else switch(t){case 1:return"#BCBCBC";case 2:return"#989898";case 3:return"#747474";case 4:return"#565656";case 5:return"#343434";default:return"#FFF"}}function createAlignmentDiv(e,t,n,l){var i=document.createElement("div"),r=document.createElement("div"),a=document.createElement("div"),d=document.createElement("div"),o=document.createElement("a");return i.style.minHeight="12px",r.style.width=t+"px",r.style.minHeight="4px",r.style["float"]="left",a.style.width=n+"px",a.style.minHeight="12px",a.style["float"]="left",a.style.backgroundColor=e,a.onmouseout=function(){document.getElementById("defline").value=" Mouse over to show defline and scores, click to show alignments"},a.onmouseover=function(){document.getElementById("defline").value=" "+l.description+". S="+l.score+" E="+l.eValue},d.style.clear="both",o.href="#"+l.description.split(" ")[0],o.onclick=function(){selectAlignment(l.description.split(" ")[0])},o.appendChild(a),i.appendChild(r),i.appendChild(o),i.appendChild(d),i}function selectAlignment(e){var t,n=document.getElementById(e).parentElement.parentElement,l=document.getElementsByClassName("alignment-table-description");for(t=0;t<l.length;t++)l[t].style.fontWeight="normal",l[t].parentElement.parentElement.style.fontWeight="normal";n.style.fontWeight="bold",document.getElementById(e).style.fontWeight="bold"}function createColorsDiv(e){var t=document.createElement("div"),n=document.createElement("div"),l=document.createElement("div");t.style.color="#EEE",n.style.minWidth="50px",n.style.minHeight="10px",n.style["float"]="left",t.appendChild(n);for(var i=1;5>=i;i++){var r=document.createElement("div");r.style.minWidth="100px",r.style.textAlign="center",r.style["float"]="left",r.innerHTML=getDivColorText(i).bold(),r.style.backgroundColor=getDivColor(e,i),t.appendChild(r)}return l.style.clear="both",t.appendChild(l),t}function createQueryDiv(e){var t=document.createElement("div"),n=document.createElement("div"),l=document.createElement("div"),i=document.createElement("div");return t.style.marginTop="3px",t.style.color="#5C6D7E",t.style.fontSize="10px",n.style.width="50px",n.innerHTML="QUERY".bold(),n.style["float"]="left",l.style.width="500px",l.style.height="10px",l.style["float"]="left",l.style.marginTop="2px",i.style.clear="both",e?l.style.backgroundColor="#C0392B":l.style.backgroundColor="#343434",t.appendChild(n),t.appendChild(l),t.appendChild(i),t}function createNumbersDiv(e){var t=document.createElement("div"),n=document.createElement("div"),l=document.createElement("div"),i=document.createElement("div");return t.style.marginBottom="5px",t.style.fontSize="11px",n.style.minWidth="50px",n.style.minHeight="10px",n.style["float"]="left",l.style["float"]="left",i.style.clear="both",l=divideDivNumbers(l,e),t.appendChild(n),t.appendChild(l),t.appendChild(i),t}function divideDivNumbers(e,t){var n=document.createElement("div");if(t>4)if(t%5==0)e=createDivisionsDivNumbers(e,5,t/5,100);else{var l=500/(5+t%5/5);e=createDivisionsDivNumbers(e,5,parseInt(t/5),parseInt(l));var i=parseInt(500-5*l),r=document.createElement("div");r.style["float"]="left",r.style.width=i+"px",r.style.textAlign="right",r.innerHTML=t,e.appendChild(r)}else e=createDivisionsDivNumbers(e,t,1,parseInt(500/t));return n.style.clear="both",e.appendChild(n),e}function createDivisionsDivNumbers(e,t,n,l){for(var i=0;t>i;i++)if(0==i){var r=l/2,a=document.createElement("div"),d=document.createElement("div");a.style["float"]="left",a.style.width=r+"px",a.style.textAlign="left",a.innerHTML="0",d.style["float"]="left",d.style.width=r+"px",d.style.textAlign="right",d.innerHTML=n*(i+1),e.appendChild(a),e.appendChild(d)}else{var o=document.createElement("div");o.style["float"]="left",o.style.width=l+"px",o.style.textAlign="right",o.innerHTML=n*(i+1),e.appendChild(o)}return e}function createHeader(e,t,n){var l=document.createElement("div"),i=createColorsDiv(t),r=createQueryDiv(t),a=createNumbersDiv(n);return l.style.color="#5C6D7E",l.style.textAlign="center",l.style.paddingBottom="5px",l.innerHTML="COLOR KEY FOR ALIGNMENT SCORES".bold(),e.appendChild(l),e.appendChild(i),e.appendChild(r),e.appendChild(a),e}function createBody(e,t,n,l){var i=document.createElement("div");i.style.paddingBottom="10px";for(var r=0;r<e.length;r++){var a=parseInt(50+500*(e[r].queryStart-1)/t),d=parseInt(550-a-500*(t-e[r].queryEnd)/t),o=createAlignmentDiv(getColor(l,e[r].score),a,d,e[r]);o.style.marginBottom="4px",i.appendChild(o)}return n.appendChild(i),n}function createChangeColorButton(e,t,n){var l=document.createElement("button");if(l.id="changeColors",l.className="btn",l.style.marginRight="10px",l.style.marginTop="5px",1==n)var i=document.createTextNode("Click to change colors to grayscale");else var i=document.createTextNode("Click to change colors to full colored");return l.appendChild(i),l.onclick=function(){changeColors(e,t,l,n)},l}function createDownloadButton(){var e=document.createElement("button");e.id="downloadAlignments",e.className="btn",e.style.marginTop="5px";var t=document.createTextNode("Download as image");return e.appendChild(t),e.addEventListener("click",downloadAlignmentsImg),e}function changeColors(e,t,n,l){l=1==l?!1:!0,n.removeChild(n.childNodes[0]);for(var i=document.getElementById("blast-multiple-alignments");i.firstChild;)i.removeChild(i.firstChild);createAlignmentComparison(e,t,l)}function downloadAlignmentsImg(){var e=document.getElementById("blast-multiple-alignments-buttons"),t=document.getElementById("defline"),n=document.getElementById("alignments-container");n.removeChild(e),n.removeChild(t),html2canvas(n,{onrendered:function(l){document.body.appendChild(l);var i=document.createElement("a");document.body.appendChild(i),i.href=l.toDataURL("img/png"),i.download="alignments.png",i.click(),document.body.removeChild(l),document.body.removeChild(i),n.appendChild(t),n.appendChild(e)}})}function createAlignmentComparison(e,t,n){for(var l=document.getElementById("blast-multiple-alignments");l.hasChildNodes();)l.removeChild(l.firstChild);var i=document.createElement("div"),r=document.createElement("div"),a=document.createElement("input"),d=createChangeColorButton(e,t,n),o=createDownloadButton();l.style.paddingTop="20px",a.id="defline",a.name="defline",a.type="text",a.value=" Mouse over to show defline and scores, click to show alignments",a.style.width="556px",a.style.padding="1px",a.style.border=0,a.style.cursos="auto",i.id="alignments-container",i.style.border="thin solid #DDD",i.style.margin="0 auto",i.style.padding="10px",i.style.maxWidth="580px",i.style.backgroundColor="#FFF",i=createHeader(i,n,t),i=createBody(e,t,i,n),i.appendChild(a),r.style.textAlign="right",r.id="blast-multiple-alignments-buttons",l.style.minWidth="580px",r.appendChild(d),r.appendChild(o),i.appendChild(r),l.appendChild(i)}function createTableHeader(){var e=document.createElement("table"),t=document.createElement("thead"),n=document.createElement("tr"),l=document.createElement("th"),i=document.createElement("th"),r=document.createElement("th"),a=document.createElement("th"),d=document.createElement("th"),o=document.createElement("th");return e.className="table table-striped",l.innerHTML="Description".bold(),i.innerHTML="Score".bold(),r.innerHTML="E value".bold(),a.innerHTML="Identities".bold(),d.innerHTML="Positives".bold(),o.innerHTML="Gaps".bold(),n.appendChild(l),n.appendChild(i),n.appendChild(r),n.appendChild(a),n.appendChild(d),n.appendChild(o),t.appendChild(n),e.appendChild(t),e}function createTableButtons(e){var t=document.createElement("div"),n=document.createElement("button"),l=document.createElement("button");return t.style.textAlign="right",n.style.marginRight="10px",n.className="btn",n.innerHTML="Download as csv",n.onclick=function(){downloadTableCSV(e)},l.className="btn",l.innerHTML="Download as image",l.onclick=function(){downloadTableImg()},t.appendChild(n),t.appendChild(l),t}function createAlignmentTable(e){for(var t=document.getElementById("blast-alignments-table");t.hasChildNodes();)t.removeChild(t.firstChild);var n=document.createElement("div"),l=createTableButtons(e),i=createTableHeader(),r=document.createElement("tbody");t.style.paddingTop="50px",n.style.backgroundColor="#FFF",n.id="blast-alignments-table-img";for(var a=0;a<e.length;a++){var d=document.createElement("tr"),o=document.createElement("td"),s=document.createElement("button");s.alignment=e[a],s.onclick=function(){location.href="#blast-single-alignment",createSingleAlignment(this.alignment)},s.id=e[a].description.split(" ")[0],s.innerHTML=e[a].description,s.style.border=0,s.style.padding=0,s.style.display="inline",s.style.background="none",s.className="alignment-table-description",o.appendChild(s);var c=document.createElement("td");c.innerHTML=e[a].score;var p=document.createElement("td");p.innerHTML=e[a].eValue;var m=document.createElement("td");m.innerHTML=e[a].identities+"%";var u=document.createElement("td");u.innerHTML=e[a].positives+"%";var g=document.createElement("td");g.innerHTML=e[a].gaps+"%",d.appendChild(o),d.appendChild(c),d.appendChild(p),d.appendChild(m),d.appendChild(u),d.appendChild(g),r.appendChild(d)}i.appendChild(r),n.appendChild(i),t.appendChild(n),t.appendChild(l)}function downloadTableImg(){var e,t=document.getElementsByClassName("alignment-table-description");for(e=0;e<t.length;e++)t[e].style.fontWeight="normal",t[e].parentElement.parentElement.style.fontWeight="normal";var n=document.getElementById("blast-alignments-table-img");html2canvas(n,{onrendered:function(e){document.body.appendChild(e);var t=document.createElement("a");document.body.appendChild(t),t.href=e.toDataURL("img/png"),t.download="alignments-table.png",t.click(),document.body.removeChild(e),document.body.removeChild(t)}})}function downloadTableCSV(e){var t="data:text/csv;charset=utf-8,";t+="Description; Score; eValue; Identities; Positives; Gaps\n";for(var n=0;n<e.length;n++)t+=e[n].description,t+="; ",t+=e[n].score,t+="; ",t+=e[n].eValue,t+="; ",t+=e[n].identities,t+="; ",t+=e[n].positives,t+="; ",t+=e[n].gaps,t+="\n";var l=encodeURI(t),i=document.createElement("a");i.setAttribute("href",l),i.setAttribute("download","alignments-table.csv"),i.click()}function createSingleAlignment(e){for(var t=document.getElementById("blast-single-alignment");t.hasChildNodes();)t.removeChild(t.firstChild);var n=document.createElement("pre"),l=document.createElement("div"),i=document.createElement("button"),r=document.createElement("span"),a=createSingleQueryDiv(e.query,e.queryStart,e.queryEnd),d=createSingleComparisonDiv(e.comparison),o=createSingleSubjectDiv(e.subject,e.subjectStart,e.subjectEnd);n.style.color="#2c3e50",n.style.paddingTop="25px",n.style.paddingBottom="40px",n.style.textAlign="left",n.style.fontFamily="Helvetica,Arial,sans-serif",n.id="blast-single-alignment-pre",l.style.margin="0 auto",l.style.display="table",l.style.paddingTop="30px",t.style.textAlign="right",t.style.paddingTop="50px",i.className="btn",i.innerHTML="Download as image",i.onclick=function(){downloadSingleAlignmentImg(e)},r.innerHTML=e.description,r.style.paddingLeft="15px",r.style.fontWeight="bold",r.style.fontSize="15px",r.style.fontFamily="Helvetica,Arial,sans-serif",l.appendChild(a),l.appendChild(d),l.appendChild(o),n.appendChild(r),n.appendChild(l),t.appendChild(n),t.appendChild(i)}function downloadSingleAlignmentImg(e){var t=document.getElementById("blast-single-alignment-pre");html2canvas(t,{onrendered:function(t){document.body.appendChild(t);var n=document.createElement("a");document.body.appendChild(n),n.href=t.toDataURL("img/png");var l=e.description+"-alignment.png";n.download=l,n.click(),document.body.removeChild(t),document.body.removeChild(n)}})}function createSingleQueryDiv(e,t,n){var l=document.createElement("div"),i=document.createElement("div"),r=document.createElement("div"),a=document.createElement("div");l.innerHTML="Query".bold(),l.style.display="inline-block",l.style.marginRight="20px",l.style.textAlign="right",l.style.width="55px",i.innerHTML=String(t).bold(),i.style.display="inline-block",i.style.marginRight="20px",i.style.width="25px",r.innerHTML=String(n).bold(),r.style.display="inline-block",r.style.marginLeft="20px",r.style.marginRight="70px",a.appendChild(l),a.appendChild(i);for(var d=0;d<e.length;d++){var o=document.createElement("div");o.style.backgroundColor=getAminoColor(e.charAt(d)),o.innerHTML=e.charAt(d).bold(),o.style.width="18px",o.style.textAlign="center",o.style.display="inline-block",a.appendChild(o)}return a.appendChild(r),a}function createSingleComparisonDiv(e){var t=document.createElement("div"),n=document.createElement("div");n.style.minWidth="120px",n.style.minHeight="1px",n.style.display="inline-block",t.appendChild(n);for(var l=0;l<e.length;l++){var i=document.createElement("div");i.style.backgroundColor=getAminoColor(e.charAt(l)),i.innerHTML=e.charAt(l).bold(),i.style.width="18px",i.style.textAlign="center",i.style.display="inline-block",t.appendChild(i)}return t}function createSingleSubjectDiv(e,t,n){var l=document.createElement("div"),i=document.createElement("div"),r=document.createElement("div"),a=document.createElement("div");l.innerHTML="Subject".bold(),l.style.display="inline-block",l.style.textAlign="right",l.style.marginRight="20px",l.style.width="55px",i.style.width="25px",i.innerHTML=String(t).bold(),i.style.display="inline-block",i.style.marginRight="20px",r.innerHTML=String(n).bold(),r.style.display="inline-block",r.style.marginLeft="20px",r.style.marginRight="70px",a.appendChild(l),a.appendChild(i);for(var d=0;d<e.length;d++){var o=document.createElement("div");o.style.backgroundColor=getAminoColor(e.charAt(d)),o.innerHTML=e.charAt(d).bold(),o.style.width="18px",o.style.textAlign="center",o.style.display="inline-block",a.appendChild(o)}return a.appendChild(r),a}function getAminoColor(e){switch(e){case"A":return"#DBFA60";case"C":return"#F9FA60";case"D":return"#F9605F";case"E":return"#F9609C";case"F":return"#5FF99D";case"G":return"#F9BC5F";case"H":return"#609DF9";case"I":return"#99F95A";case"K":return"#A062FF";case"L":return"#7EF960";case"M":return"#63FF63";case"N":return"#D95DF9";case"P":return"#F9DA60";case"Q":return"#F955D8";case"R":return"#5360FB";case"S":return"#F97E60";case"T":return"#FFA563";case"V":return"#C0F86B";case"W":return"#FDD9F9";case"Y":return"#60F9DA";default:return"#FFFFFF"}}String.prototype.startsWith=function(e){return 0===this.indexOf(e)};var css="table tbody tr td button:hover{ text-decoration: underline; }",style=document.createElement("style");style.styleSheet?style.styleSheet.cssText=css:style.appendChild(document.createTextNode(css)),document.getElementsByTagName("head")[0].appendChild(style),document.getElementById("blastinput").addEventListener("change",readBlastFile,!1);